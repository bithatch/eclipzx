<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>uk.co.bithatch</groupId>
		<artifactId>uk.co.bithatch.eclipzx.parent</artifactId>
		<version>1.0.0-SNAPSHOT</version>
		<relativePath>../</relativePath>
	</parent>
	<artifactId>eclipzx-packages</artifactId>
	<name>EclipZX Packages</name>
	<description>An Eclipse based IDE for writing ZX Spectrum and ZX Spectrum Next games and applications.</description>
    <licenses>
        <license>
            <name>EPL-2.0</name>
            <url>https://www.eclipse.org/org/documents/epl-2.0/EPL-2.0.txt</url>
            <distribution>repo</distribution>
        </license>
    </licenses>
    <build>
        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>uk.co.bithatch</groupId>
                    <artifactId>flatpak-maven-plugin</artifactId>
                    <version>0.0.3</version>
                    <configuration>
                        <skip>true</skip>
                    </configuration>
                </plugin>
            </plugins>
        </pluginManagement>
    </build>    
    <profiles>
        <profile>
            <id>products</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>uk.co.bithatch</groupId>
                        <artifactId>flatpak-maven-plugin</artifactId> 
                        <configuration>
                            <skip>false</skip>
                        </configuration>
                    </plugin>
                    
                    <plugin>
                        <groupId>org.digitalmediaserver</groupId>
                        <artifactId>nsis-maven-plugin</artifactId>
                        <version>1.0.6</version>
                        <executions>
                            <execution>
                                <id>build-windows-installer</id>
                                <configuration>
                                    <scriptFile>${basedir}/src/main/nsis/eclipzx.nsi</scriptFile>
                                    <outputFile>EclipZX.exe</outputFile>
                                    <attachArtifact>false</attachArtifact>
                                </configuration>
                                <phase>package</phase>
                                <goals>
                                    <goal>generate-headerfile</goal>
                                    <goal>make</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>flatpak</id>
            <activation>
                <os>
                    <family>linux</family>
                </os>
            </activation>
            <build>
                <plugins>
                    <plugin>
                        <!--  https://github.com/flathub/org.eclipse.Java/blob/master/org.eclipse.Java.json -->
                        <groupId>uk.co.bithatch</groupId>
                        <artifactId>flatpak-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>eclipzx-prep-flatpak</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>create</goal>
                                </goals>
                                <configuration>
                                    <appModuleName>eclipzx</appModuleName>
                                    <desktopEntry>
                                        <categories>Development</categories>
                                         <exec>/app/eclipzx/eclipzx</exec>
                                    </desktopEntry>
                                     <metaInfo>
                                        <name>EclipZX</name>
                                     </metaInfo>
                                    <manifest>
                                     <runtime>org.gnome.Platform</runtime>
                                     <runtimeVersion>49</runtimeVersion>
                                     <sdk>org.gnome.Sdk</sdk>
                                         <appId>uk.co.bithatch.EclipZX</appId>
                                        <modules>
                                            <module>
                                                <name>gdk-pixbuf</name>
                                                <buildSystem>meson</buildSystem>
                                                <configOpts>
                                                    <configOpt>-Dothers=enabled</configOpt>
                                                    <configOpt>-Dman=false</configOpt>
                                                    <configOpt>-Ddocumentation=false</configOpt>
                                                    <configOpt>-Dtests=false</configOpt>
                                                    <configOpt>-Dinstalled_tests=false</configOpt>
                                                    <configOpt>-Dbuiltin_loaders=all</configOpt>
                                                </configOpts>                                                
                                                <sources>
                                                  <source>
                                                     <type>git</type>
                                                     <url>https://gitlab.gnome.org/GNOME/gdk-pixbuf.git</url>
                                                     <tag>2.44.1</tag>
                                                  </source>      
                                                  <source>
                                                     <type>file</type>
                                                     <url>https://repo.eclipse.org/content/repositories/linuxtools/org/eclipse/linuxtools/flatpak/flatpak-dev-shim/1.0.1-SNAPSHOT/flatpak-dev-shim-1.0.1-20250722.150010-10.jar</url>
                                                     <sha256>1a421e396bf43d423d64d2943aea4900d142749d58a7ea5fb777a484049a2271</sha256>
                                                     <destFilename>flatpak-dev-shim-1.0.1-SNAPSHOT.jar</destFilename>
                                                  </source>                                  
                                                  <source>
                                                     <type>file</type>
                                                     <url>https://repo.eclipse.org/content/repositories/linuxtools/org/eclipse/linuxtools/flatpak/flatpak-dev-shim/1.0.1-SNAPSHOT/flatpak-dev-shim-1.0.1-20250722.150010-10.so</url>
                                                     <sha256>6460250a44558e8ccb475705a40273eb0065e8cf746839ff5f502fc184d2c3df</sha256>
                                                     <destFilename>flatpak-dev-shim-1.0.1-SNAPSHOT.so</destFilename>
                                                  </source>
                                                </sources>
                                            </module>
                                            <module>
                                                <name>eclipzx</name>
                                                <buildCommand> 
                                                  find app/eclipzx -type f -exec install -Dm 755 "{}" "/{}" \;
                                                  install -Dm 644 flatpak-dev-shim-1.0.1-SNAPSHOT.jar /app/eclipzx/flatpak-dev-shim.jar
                                                  install -Dm 644 flatpak-dev-shim-1.0.1-SNAPSHOT.so /app/lib/libflatpakdevshim.so
                                                  sed -i -e '/osgi.configuration.area/d' /app/eclipzx/eclipzx.ini
                                                  echo "-Dosgi.configuration.area=@user.home/.var/app/uk.co.bithatch.EclipZX/eclipzx/configuration" >> /app/eclipzx/eclipzx.ini
                                                  echo "--patch-module=java.base=/app/eclipzx/flatpak-dev-shim.jar" >> /app/eclipzx/eclipzx.ini
                                                  echo "-Dsun.boot.library.path=/app/lib" >> /app/eclipzx/eclipzx.ini
                                                </buildCommand>
                                                <sources>
                                                  <source>
                                                     <type>dir</type>
                                                     <path>${basedir}/../uk.co.bithatch.eclipzx.repository/target/products/eclipzx/linux/gtk/x86_64</path>
                                                     <dest>app/eclipzx</dest>
                                                  </source>
                                                </sources>
                                                 <buildOptions>
                                                    <noDebuginfo>true</noDebuginfo>
                                                 </buildOptions>
                                            </module>
                                        </modules>
                                         <command>/app/eclipzx/eclipzx</command>
                                         <finishArgs>
                                            <finishArg>--require-version=1.7.1</finishArg>
                                            <finishArg>--socket=session-bus</finishArg>
                                            <finishArg>--socket=x11</finishArg>
                                            <finishArg>--socket=pulseaudio</finishArg>
                                            <finishArg>--socket=wayland</finishArg>
                                            <finishArg>--socket=ssh-auth</finishArg>
                                            <finishArg>--socket=fallback-x11</finishArg>
                                            <finishArg>--device=dri</finishArg>
                                            <finishArg>--filesystem=host</finishArg>
                                            <finishArg>--filesystem=/tmp:rw</finishArg>
                                            <finishArg>--share=network</finishArg>
                                            <finishArg>--share=ipc</finishArg>
                                            <finishArg>--allow=devel</finishArg>
                                            <finishArg>--persist=.eclipzx</finishArg>
                                            <finishArg>--talk-name=org.freedesktop.secrets</finishArg>
                                        </finishArgs>
                                    </manifest>
                                    <iconFile>../uk.co.bithatch.eclipzx.ui/content/svg/eclipzx.svg</iconFile>
                                </configuration>
                            </execution>
                            <execution>
                                <id>eclipzx-build-flatpak</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>build</goal>
                                </goals>
                                <configuration>
                                     <appId>uk.co.bithatch.EclipZX</appId>
                                     <install>false</install>
                                </configuration>
                            </execution>
                            <execution>
                                <id>eclipzx-deploy-flatpak</id>
                                <phase>deploy</phase>
                                <goals>
                                    <goal>build</goal>
                                </goals>
                                <configuration>
                                     <appId>uk.co.bithatch.EclipZX</appId>
                                     <install>true</install>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        
    </profiles>
	<packaging>pom</packaging>
</project>
